<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Black Market Brief</title>

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --blue:#1b4cff;
      --red:#d61f2c;
      --muted:#333;
      --thin:#e9e9e9;
    }

    body{
      background:#fff;
      color:#000;
      font-family:Arial, Helvetica, sans-serif;
      margin:0;
      padding:14px 12px;
      max-width:900px;
      margin-left:auto;
      margin-right:auto;
      -webkit-text-size-adjust:100%;
    }

    h1{
      text-align:center;
      font-size:42px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:3px;
      font-style:italic;
      transform:skew(-8deg);
      margin:8px 0;
      text-shadow:
        2px 2px 0 var(--blue),
        4px 4px 0 var(--red),
        6px 6px 0 rgba(0,0,0,0.18);
    }

    .subhead{
      text-align:center;
      font-size:13px;
      font-weight:800;
      margin:0 0 12px;
      letter-spacing:.8px;
      text-transform:uppercase;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      margin:8px 0 12px;
      flex-wrap:wrap;
      gap:8px;
    }

    .pill{
      border:1px solid var(--thin);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      text-transform:uppercase;
      background:#fafafa;
    }

    /* =========================
       MOBILE-SAFE STATS TICKER
       ========================= */

    .stats-bar{
      border:1px solid var(--thin);
      background:#fafafa;
      margin:14px 0 22px;
      overflow:hidden;
    }

    .stats-mask{
      width:100%;
      overflow:hidden;
    }

    .stats-track{
      display:flex;
      gap:28px;
      padding:10px 0;
      will-change:transform;
      animation:stats-scroll 30s linear infinite;
    }

    .stat{
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
    }

    @keyframes stats-scroll{
      from{ transform:translateX(100%); }
      to{ transform:translateX(-100%); }
    }

    @media (hover:hover){
      .stats-bar:hover .stats-track{
        animation-play-state:paused;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .stats-track{
        animation:none;
      }
    }

    /* =========================
       HEADLINES
       ========================= */

    ul{
      list-style:none;
      padding:0;
      margin:0;
    }

    .state-header{
      margin:20px 0 6px;
      font-size:13px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    .headline-item{
      margin:0 0 14px;
      padding-left:14px;
      font-size:17px;
      line-height:1.25;
      position:relative;
    }

    .headline-item::before{
      content:"–";
      position:absolute;
      left:0;
      color:#999;
      font-weight:900;
    }

    a{
      color:#000;
      text-decoration:underline;
      font-weight:900;
      word-break:break-word;
    }

    a:hover{ color:#0033cc; }

    .footer{
      text-align:center;
      margin-top:26px;
      font-size:13px;
      color:var(--muted);
    }

    @media (min-width:700px){
      body{ padding:20px; }
      h1{ font-size:54px; }
      .subhead{ font-size:16px; }
      .headline-item{ font-size:18px; }
    }
  </style>
</head>

<body>

  <h1>BLACK MARKET BRIEF</h1>
  <div class="subhead">
    Disrupting the Illegal Chinese Vape Supply Chain • Protecting Communities
  </div>

  <div class="meta">
    <div class="pill">Live Desk</div>
    <div id="last-updated">Updated: —</div>
  </div>

  <!-- Stats Ticker -->
  <div class="stats-bar">
    <div class="stats-mask">
      <div id="stats-track" class="stats-track">
        <div class="stat">Loading totals…</div>
      </div>
    </div>
  </div>

  <!-- Headlines -->
  <ul id="headline-list">
    <li>Loading headlines…</li>
  </ul>

  <script>
    /* =========================
       DATA SOURCES
       ========================= */

    const HEADLINES_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTz6qSLgIjDAsDkravmNu3PKrXbDHyGfKHAEY5r0Tyg0ot0co7rCX_S0Y5XtDgOQ34q0DBH1o1tRbbE/pub?gid=1559123090&single=true&output=tsv";

    const STATS_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTz6qSLgIjDAsDkravmNu3PKrXbDHyGfKHAEY5r0Tyg0ot0co7rCX_S0Y5XtDgOQ34q0DBH1o1tRbbE/pub?gid=1186883001&single=true&output=tsv";

    /* =========================
       HELPERS
       ========================= */

    function splitTSV(line){
      return line.split("\t").map(v => (v||"").trim().replace(/^"|"$/g,""));
    }

    function normalizeState(s){
      return (s || "Unknown").trim() || "Unknown";
    }

    function parseHeadlinesTSV(text){
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];

      const headers = splitTSV(lines[0]).map(h => h.toLowerCase());
      const idxTitle = headers.indexOf("article title");
      const idxLink  = headers.indexOf("link");
      const idxState = headers.indexOf("state");

      return lines.slice(1).map(row => {
        const cols = splitTSV(row);
        return {
          title: cols[idxTitle],
          url: cols[idxLink],
          state: cols[idxState]
        };
      }).filter(r => r.title && r.url);
    }

    /* =========================
       LOAD STATS (ROW 1)
       ========================= */

    fetch(STATS_URL)
      .then(r => r.text())
      .then(t => {
        const lines = t.trim().split(/\r?\n/);
        const row = lines[0];
        if (!row) return;

        const stats = splitTSV(row).filter(Boolean);
        const track = document.getElementById("stats-track");
        track.innerHTML = "";

        const doubled = stats.concat(stats);
        doubled.forEach(txt => {
          const d = document.createElement("div");
          d.className = "stat";
          d.textContent = txt;
          track.appendChild(d);
        });

        /* Force iOS Safari reflow */
        track.style.animation = "none";
        track.offsetHeight;
        track.style.animation = "";
      });

    /* =========================
       LOAD HEADLINES
       ========================= */

    fetch(HEADLINES_URL)
      .then(r => r.text())
      .then(t => {
        const entries = parseHeadlinesTSV(t).slice(0, 500);

        entries.sort((a, b) => {
          const sa = normalizeState(a.state);
          const sb = normalizeState(b.state);
          if (sa === "National" && sb !== "National") return -1;
          if (sb === "National" && sa !== "National") return 1;
          if (sa !== sb) return sa.localeCompare(sb);
          return a.title.localeCompare(b.title);
        });

        const list = document.getElementById("headline-list");
        list.innerHTML = "";
        let currentState = null;

        entries.forEach(item => {
          const state = normalizeState(item.state);

          if (state !== currentState) {
            currentState = state;
            const h = document.createElement("li");
            h.className = "state-header";
            h.textContent = state;
            list.appendChild(h);
          }

          const li = document.createElement("li");
          li.className = "headline-item";
          const a = document.createElement("a");
          a.href = item.url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.title;
          li.appendChild(a);
          list.appendChild(li);
        });

        document.getElementById("last-updated").textContent =
          "Updated: " + new Date().toLocaleString();
      })
      .catch(() => {
        document.getElementById("headline-list").innerHTML =
          "<li>Unable to load headlines.</li>";
      });
  </script>

  <div class="footer">
    Built to track contraband enforcement actions.
  </div>

</body>
</html>
